ğŸ”„ LUá»’NG Dá»® LIá»†U CHI TIáº¾T
Flow 1: User gá»­i video event (PLAY/PAUSE/SEEK)
1. User gá»­i video event tá»›i STOMP endpoint: /app/rooms/{roomId}/video
2. VideoSyncController nháº­n event vÃ  gá»i VideoSyncService Ä‘á»ƒ xá»­ lÃ½
3. VideoSyncService cáº­p nháº­t tráº¡ng thÃ¡i video trong Redis vÃ  broadcast tá»›i táº¥t cáº£ participants
4. CÃ¡c participants nháº­n Ä‘Æ°á»£c video event vÃ  cáº­p nháº­t tráº¡ng thÃ¡i video tÆ°Æ¡ng á»©ng
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client A   â”‚ (Host phÃ¡t video)
â”‚ (Frontend)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. client.publish({
       â”‚    destination: "/app/rooms/{roomId}/video",
       â”‚    body: { type: "PLAY", currentTime: 10.5 }
       â”‚ })
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STOMP Broker (Spring WebSocket)                â”‚
â”‚  - Nháº­n message táº¡i /app/rooms/{roomId}/video   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VideoSyncController.handleVideoEvent()          â”‚
â”‚  2. Extract participantId tá»« session             â”‚
â”‚  3. Validate room exists                         â”‚
â”‚  4. Set metadata (participantId, timestamp)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VideoSyncService.broadcastVideoEvent()          â”‚
â”‚  5. updateRoomVideoState() â†’ LÆ°u Redis           â”‚
â”‚     - room.playbackState = "PLAYING"             â”‚
â”‚     - room.lastPosition = 10.5                   â”‚
â”‚     - room.lastSyncAt = now()                    â”‚
â”‚  6. messagingTemplate.convertAndSend(            â”‚
â”‚       "/topic/rooms/{roomId}/video", event)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STOMP Broker                                    â”‚
â”‚  - Broadcast tá»›i táº¥t cáº£ subscribers cá»§a          â”‚
â”‚    /topic/rooms/{roomId}/video                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“          â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Client A â”‚ â”‚Client B â”‚ â”‚Client C â”‚
â”‚(Host)   â”‚ â”‚(Guest)  â”‚ â”‚(Guest)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  7. Nháº­n event vÃ  sync player state
     - setIsPlaying(true)
     - setCurrentTime(10.5)

     Flow 2: User má»›i join room (nháº­n initial state)
     1. User má»›i join room sáº½ gá»­i request tá»›i STOMP endpoint: /app/rooms/{roomId}/video/sync
     2. VideoSyncController nháº­n request vÃ  gá»i VideoSyncService Ä‘á»ƒ láº¥y tráº¡ng thÃ¡i video hiá»‡n táº¡i
     3. VideoSyncService láº¥y thÃ´ng tin room tá»« Redis vÃ  gá»­i láº¡i tráº¡ng thÃ¡i video cho user
     4. User nháº­n Ä‘Æ°á»£c tráº¡ng thÃ¡i video vÃ  cáº­p nháº­t player state tÆ°Æ¡ng á»©ng

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client D   â”‚ (User má»›i)
â”‚ (Frontend)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. Gá»i API POST /api/rooms/{roomId}/join
       â”‚    â†’ Nháº­n accessToken (cookie)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RoomController.joinRoom()                       â”‚
â”‚  2. Táº¡o/láº¥y participant                          â”‚
â”‚  3. Set cookie WT_ACCESS_TOKEN                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. Client káº¿t ná»‘i WebSocket
       â”‚    new SockJS('/ws')
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSocketHandshakeInterceptor                   â”‚
â”‚  5. Extract JWT tá»« cookie                        â”‚
â”‚  6. Validate token                               â”‚
â”‚  7. Set session attributes (participantId, roomId)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client subscribes:                              â”‚
â”‚  - /topic/rooms/{roomId}/video (room events)     â”‚
â”‚  - /queue/video/sync (initial state)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 8. Client gá»­i REQUEST_SYNC
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VideoSyncService.sendCurrentStateToUser()       â”‚
â”‚  9. Láº¥y room state tá»« Redis                      â”‚
â”‚ 10. Táº¡o SYNC_STATE event vá»›i:                    â”‚
â”‚     - currentVideoUrl                            â”‚
â”‚     - lastPosition                               â”‚
â”‚     - playbackState                              â”‚
â”‚ 11. Send riÃªng tá»›i user:                         â”‚
â”‚     messagingTemplate.convertAndSendToUser(      â”‚
â”‚       sessionId, "/queue/video/sync", event)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client D nháº­n SYNC_STATE                        â”‚
â”‚ 12. setVideoUrl(currentVideoUrl)                 â”‚
â”‚ 13. setCurrentTime(lastPosition)                 â”‚
â”‚ 14. setIsPlaying(playbackState === "PLAYING")    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¯ ÄIá»‚M QUAN TRá»ŒNG
WebSocket authentication: JWT Ä‘Æ°á»£c validate trong WebSocketHandshakeInterceptor trÆ°á»›c khi cho phÃ©p káº¿t ná»‘i
State persistence: Video state Ä‘Æ°á»£c lÆ°u trong Redis Ä‘á»ƒ user má»›i join cÃ³ thá»ƒ sync
Broadcast pattern: DÃ¹ng /topic cho room-wide messages, /queue cho user-specific
TTL: Room tá»± Ä‘á»™ng bá»‹ xÃ³a sau 24h (Redis TTL)
Security: Má»—i participant pháº£i cÃ³ valid JWT token, kiá»ƒm tra roomId match